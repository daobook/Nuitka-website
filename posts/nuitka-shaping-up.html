<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
    <link rel="icon" href="../_static/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="../_static/favicon.png" sizes="32x32" type="image/png">
    <link rel="icon" href="../_static/favicon.ico" sizes="32x32" type="image/x-icon">
    <link rel="icon" href="../_static/apple-touch-icon-iphone.png" sizes="57x57" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-ipad.png" sizes="72x72" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-iphone4.png" sizes="114x114" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-ipad3.png" sizes="144x144" type="image/png">
    <link rel="apple-touch-icon" href="../_static/apple-touch-icon-180x180.png" sizes="180x180" type="image/png">

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nuitka shaping up</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/asciinema-player_2.6.1.css" type="text/css" />
      <link rel="stylesheet" href="../_static/asciinema-custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/my_theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/design-style.59c74d8c95b765a7fd995ac71d459ebe.min.css" type="text/css" />
    <link rel="canonical" href="https://nuitka.net/posts/nuitka-shaping-up.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/tabs.js"></script>
        <script src="../_static/asciinema-player_2.6.1.js"></script>
        <script src="../_static/design-tabs.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />   
<link
  rel="alternate"
  type="application/atom+xml"
  href="../blog/atom.xml"
  title="Nuitka Blog"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Nuitka the Python Compiler
            <img src="../_static/Nuitka-Logo-Symbol.png" class="logo" alt="Logo"/>
          </a><!-- Empty override file take the place of searchbox.html, which generates search box. -->
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/download.html">Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/support.html">Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Commercial Users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/commercial.html">Nuitka Commercial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Release Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/Changelog.html">Nuitka Release 0.6.19 (Draft)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/Changelog.html#nuitka-release-0-6-18">Nuitka Release 0.6.18</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/Changelog.html#nuitka-release-0-6-17">Nuitka Release 0.6.17</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/Changelog.html#older-releases">Older Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/roadmap.html">Roadmap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/api-doc.html">API doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/factory.html">Factory Instructions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Media</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pages/Presentations.html">Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/Streaming.html">Streaming</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pages/impressum.html">Impressum</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Under construction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/welcome.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/pyside2.html">Nuitka PySide2 support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/donations.html">Donations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/gsoc2019.html">Google Summer of Code 2019</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/nuitka-demo.html">Nuitka Demo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Nuitka the Python Compiler</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <!-- Empty override file take the place of sphinx_rtd_theme/breadcrumbs.html, which generates the top nav breadcrumbs. -->
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
              <section id="nuitka-shaping-up">
<h1><a class="toc-backref" href="#id1">Nuitka shaping up</a><a class="headerlink" href="#nuitka-shaping-up" title="Permalink to this headline"></a></h1>
<p>Not much has happened publicly to Nuitka, so it’s time to make a kind of
status post, about the exciting news there is.</p>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#nuitka-shaping-up" id="id1">Nuitka shaping up</a></p>
<ul>
<li><p><a class="reference internal" href="#ssa-single-state-assignment-form" id="id2">SSA (Single State Assignment Form)</a></p></li>
<li><p><a class="reference internal" href="#improved-code-generation" id="id3">Improved Code Generation</a></p></li>
<li><p><a class="reference internal" href="#scalability" id="id4">Scalability</a></p></li>
<li><p><a class="reference internal" href="#compatibility" id="id5">Compatibility</a></p>
<ul>
<li><p><a class="reference internal" href="#python2-exec-statements" id="id6">Python2 exec statements</a></p></li>
<li><p><a class="reference internal" href="#python3-classes" id="id7">Python3 classes</a></p></li>
<li><p><a class="reference internal" href="#python3-4" id="id8">Python3.4</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#performance" id="id9">Performance</a></p>
<ul>
<li><p><a class="reference internal" href="#graphs-and-benchmarks" id="id10">Graphs and Benchmarks</a></p></li>
<li><p><a class="reference internal" href="#incremental-assignments" id="id11">Incremental Assignments</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#standalone" id="id12">Standalone</a></p></li>
<li><p><a class="reference internal" href="#other-stuff" id="id13">Other Stuff</a></p>
<ul>
<li><p><a class="reference internal" href="#funding" id="id14">Funding</a></p></li>
<li><p><a class="reference internal" href="#collaborators" id="id15">Collaborators</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#future" id="id16">Future</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="ssa-single-state-assignment-form">
<h2><a class="toc-backref" href="#id2">SSA (Single State Assignment Form)</a><a class="headerlink" href="#ssa-single-state-assignment-form" title="Permalink to this headline"></a></h2>
<p>For a long, long time already, each release of Nuitka has worked towards
enabling <a class="reference external" href="http://en.wikipedia.org/wiki/Static_single_assignment_form">“SSA”</a> usage in
Nuitka. There is a component called “constraint collection”, which is
tasked with driving the optimization, and collecting variable traces.</p>
<p>Based on these traces, optimizations could be made. Having SSA or not,
is (to me) the difference between Nuitka as a compiler, and Nuitka as an
optimizing compiler.</p>
<p>The news is, SSA is shaping up, and will be used in the next release.
Not yet to drive variable based optimization (reserved for a release
after it), but to aid the code generation to avoid useless checks.</p>
</section>
<section id="improved-code-generation">
<h2><a class="toc-backref" href="#id3">Improved Code Generation</a><a class="headerlink" href="#improved-code-generation" title="Permalink to this headline"></a></h2>
<p>Previously, under the title “C-ish”, Nuitka moved away from C++ based
code generation to less C++ based code generated, and more C-ish code.
This trend continues, and has lead to removing even more code cleanups.</p>
<p>The more important change is from the SSA derived knowledge. Now Nuitka
knows that a variable must be assigned, cannot be assigned, may be
assigned, based on its SSA traces.</p>
<p>Lets check out an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>
</pre></div>
</div>
<p>Nevermind, that <em>obviously</em> the variable <code class="docutils literal notranslate"><span class="pre">a</span></code> can be removed, and this
could be transformed to statically return <code class="docutils literal notranslate"><span class="pre">1</span></code>. That is the next step
(and easy if SSA is working properly), now we are looking at what
changed now.</p>
<p>This is code as generated now, with current 0.5.5pre5:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_assign_source_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const_int_pos_1</span><span class="p">;</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INCREASE_REFCOUNT</span><span class="p">(</span><span class="w"> </span><span class="n">tmp_assign_source_1</span><span class="w"> </span><span class="p">);</span><span class="w"></span>

<span class="n">tmp_return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="p">;</span><span class="w"></span>

<span class="n">Py_INCREF</span><span class="p">(</span><span class="w"> </span><span class="n">tmp_return_value</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="k">goto</span><span class="w"> </span><span class="n">function_return_exit</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>There are some things, wrong with it still. For one, <code class="docutils literal notranslate"><span class="pre">var_a</span></code> is still
a C++ object, which we directly access. But the good thing is, we can
assert that it starts out uninitialized, before we overwrite it. The
stable release as of now, 0.5.4, generates code like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_assign_source_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const_int_pos_1</span><span class="p">;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INCREASE_REFCOUNT</span><span class="p">(</span><span class="w"> </span><span class="n">tmp_assign_source_1</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">else</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INCREASE_REFCOUNT</span><span class="p">(</span><span class="w"> </span><span class="n">tmp_assign_source_1</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">PyFrameObject</span><span class="w"> </span><span class="o">*</span><span class="n">cache_frame_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="n">MAKE_OR_REUSE_FRAME</span><span class="p">(</span><span class="w"> </span><span class="n">cache_frame_function</span><span class="p">,</span><span class="w"> </span><span class="n">codeobj_4e03e5698a52dd694c5c263550d71551</span><span class="p">,</span><span class="w"> </span><span class="n">module___main__</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="n">PyFrameObject</span><span class="w"> </span><span class="o">*</span><span class="n">frame_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache_frame_function</span><span class="p">;</span><span class="w"></span>

<span class="c1">// Push the new frame as the currently active one.</span>
<span class="n">pushFrameStack</span><span class="p">(</span><span class="w"> </span><span class="n">frame_function</span><span class="w"> </span><span class="p">);</span><span class="w"></span>

<span class="c1">// Mark the frame object as in use, ref count 1 will be up for reuse.</span>
<span class="n">Py_INCREF</span><span class="p">(</span><span class="w"> </span><span class="n">frame_function</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="n">Py_REFCNT</span><span class="p">(</span><span class="w"> </span><span class="n">frame_function</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// Frame stack</span>

<span class="c1">// Framed code:</span>
<span class="n">tmp_return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="p">;</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tmp_return_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">exception_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INCREASE_REFCOUNT</span><span class="p">(</span><span class="w"> </span><span class="n">PyExc_UnboundLocalError</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">exception_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSTREAM_STRING</span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="n">constant_bin</span><span class="p">[</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">exception_tb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">frame_function</span><span class="o">-&gt;</span><span class="n">f_lineno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">frame_exception_exit_1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">Py_INCREF</span><span class="p">(</span><span class="w"> </span><span class="n">tmp_return_value</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="k">goto</span><span class="w"> </span><span class="n">frame_return_exit_1</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>As you can see, the assignment to <code class="docutils literal notranslate"><span class="pre">var_a.object</span></code> was checking if it
were <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, and if were not (which we now statically know), would
release the old value. Next up, before returning, the value of
<code class="docutils literal notranslate"><span class="pre">var_a.object</span></code> needed to be checked, if it were <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, in which
case, we would need to create a Python exception, and in order to do so,
we need to create a frame object, that even if cached, consumes time,
and code size.</p>
<p>So, that is the major change to code generation. The SSA information is
now used in it, and doing so, has found a bunch of issues, in how it is
built, in e.g. nested branches, that kind of stuff.</p>
<p>The removal of local variables as C++ classes, and them managed as
temporary variables, is going to happen in a future release, reducing
code complexity further. Were <code class="docutils literal notranslate"><span class="pre">a</span></code> a temporary variable, already, the
<code class="docutils literal notranslate"><span class="pre">Py_INCREF</span></code> which implies a later <code class="docutils literal notranslate"><span class="pre">Py_DECREF</span></code> on the constant <code class="docutils literal notranslate"><span class="pre">1</span></code>
could be totally avoided.</p>
</section>
<section id="scalability">
<h2><a class="toc-backref" href="#id4">Scalability</a><a class="headerlink" href="#scalability" title="Permalink to this headline"></a></h2>
<p>The scalability of Nuitka hinges much of generated code size. With it
being less stupid, the generated code is now not only faster, but
definitely smaller, and with more optimization, it will only become more
practical.</p>
</section>
<section id="compatibility">
<h2><a class="toc-backref" href="#id5">Compatibility</a><a class="headerlink" href="#compatibility" title="Permalink to this headline"></a></h2>
<section id="python2-exec-statements">
<h3><a class="toc-backref" href="#id6">Python2 exec statements</a><a class="headerlink" href="#python2-exec-statements" title="Permalink to this headline"></a></h3>
<p>A recent change in CPython 2.7.8+ which is supposed to become 2.7.9 one
day, highlighted an issue with <code class="docutils literal notranslate"><span class="pre">exec</span></code> statements in Nuitka. These were
considered to be fully compatible, but apparently are not totally.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">exec</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
    <span class="n">exec</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>The above two are supposed to be identical. So far this was rectified at
run time of CPython, but apparently the parser is now tasked with it, so
Nuitka now sees <code class="docutils literal notranslate"><span class="pre">exec</span> <span class="pre">a</span> <span class="pre">in</span> <span class="pre">b,</span> <span class="pre">c</span></code> for both lines. Which is good.</p>
<p>However, as it stands, Nuitka handles <code class="docutils literal notranslate"><span class="pre">exec</span></code> in <code class="docutils literal notranslate"><span class="pre">locals()</span></code> the same
as <code class="docutils literal notranslate"><span class="pre">exec</span></code> in <code class="docutils literal notranslate"><span class="pre">None</span></code> for plain functions (OK to classes and modules),
which is totally a bug.</p>
<p>I have been working on an enhanced re-formulation (it needs to be
tracked if the value was <code class="docutils literal notranslate"><span class="pre">None</span></code>, and then the sync back to locals from
the provided dictionary ought to be done. But the change breaks
<code class="docutils literal notranslate"><span class="pre">execfile</span></code> in classes, which was implemented piggy-backing on
<code class="docutils literal notranslate"><span class="pre">exec</span></code>, and now requires locals to be a dictionary, and immediately
written to.</p>
<p>Anyway, consider <code class="docutils literal notranslate"><span class="pre">exec</span></code> as well working already. The non-working cases
are really corner cases, obviously nobody came across so far.</p>
</section>
<section id="python3-classes">
<h3><a class="toc-backref" href="#id7">Python3 classes</a><a class="headerlink" href="#python3-classes" title="Permalink to this headline"></a></h3>
<p>Incidentally, that <code class="docutils literal notranslate"><span class="pre">execfile</span></code> issue will be solved as soon as a bug is
fixed, that was exposed by new abilities of Python3 metaclasses. They
were first observed in Python3.4 enum classes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyEnum</span><span class="p">(</span><span class="n">enum</span><span class="p">):</span>
    <span class="n">red</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">blue</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">red</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># error</span>
</pre></div>
</div>
<p>Currently, Nuitka is delaying the building of the dictionary (absent
<code class="docutils literal notranslate"><span class="pre">execfile</span></code> built-in), and that is not allowed, in fact, immediate
writes to the mapping giving by <code class="docutils literal notranslate"><span class="pre">__prepare__</span></code> of the metaclass will be
required, in which case, the <code class="docutils literal notranslate"><span class="pre">enum</span></code> class can raise an error for the
second assignment to <code class="docutils literal notranslate"><span class="pre">red</span></code>.</p>
<p>So that area now hinges on code generation to learn different local
variable codes for classes, centered around the notion of using the
locals dictionary immediately.</p>
</section>
<section id="python3-4">
<h3><a class="toc-backref" href="#id8">Python3.4</a><a class="headerlink" href="#python3-4" title="Permalink to this headline"></a></h3>
<p>The next release is no longer warning you if you use Python3.4, as many
of the remaining problems have been sorted out. Many small things were
found, and in some cases these highlighted general Python3 problems.</p>
<p>Nuitka for Python3 is not yet all that much in the focus in terms of
performance, but correctness will have become much better, with most
prominently, exception context being now correct most often.</p>
<p>The main focus of Nuitka is Python2, but to Nuitka the incompatibility
of Python3 is largely not all that much an issue. The re-formulations to
lower level operations for just about everything means that for the
largest part there is not much trouble in supporting a mostly only
slightly different version of Python.</p>
<p>The gain is mostly in that new tests are added in new releases, and
these sometimes find things that affect Nuitka in all versions, or at
least some others. And this could be a mere reference leak.</p>
<p>Consider this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">raise</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>So, that is working with Python2, but comes from a Python3 test. Python2
is supposed to unwrap the tuple and take the first argument and raise
that. It didn’t do that so far. Granted, obscure feature, but still an
incompatibility. For Python3, a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> should be raised
complaining that <code class="docutils literal notranslate"><span class="pre">tuple</span></code> is not derived from <code class="docutils literal notranslate"><span class="pre">BaseException</span></code>.</p>
<p>Turned out, that also, in that case, a reference leak occurs, in that
the wrong exception was not released, and therefore memory leaked.
Should that happen a lot during a programs live, it will potentially
become an issue, as it keeps frames on the traceback also alive.</p>
<p>So this lead to a compatibility fix and a reference leak fix. And it was
found by the Python3.4 suite, checking that exception objects are
properly released, and that the proper kind of exception is raised in
the no longer supported case.</p>
</section>
</section>
<section id="performance">
<h2><a class="toc-backref" href="#id9">Performance</a><a class="headerlink" href="#performance" title="Permalink to this headline"></a></h2>
<section id="graphs-and-benchmarks">
<h3><a class="toc-backref" href="#id10">Graphs and Benchmarks</a><a class="headerlink" href="#graphs-and-benchmarks" title="Permalink to this headline"></a></h3>
<p>I had been working on automated performance graphs, and they are
supposed to show up on <a class="reference external" href="https://speedcenter.nuitka.net">Nuitka Speedcenter</a> already, but currently it’s broken
and outdated.</p>
<p>Sad state of affairs. Reasons include that I found it too ugly to
publish unless updated to latest Nikola, for which I didn’t take the
time. I intend to fix it, potentially before the release though.</p>
</section>
<section id="incremental-assignments">
<h3><a class="toc-backref" href="#id11">Incremental Assignments</a><a class="headerlink" href="#incremental-assignments" title="Permalink to this headline"></a></h3>
<p>Consider the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">+=</span> <span class="s2">&quot;bbb&quot;</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">a</span></code> is a <code class="docutils literal notranslate"><span class="pre">str</span></code>, and if (and only if), it’s the only reference
being held, then CPython, reuses the object, instead of creating a new
object and copying <code class="docutils literal notranslate"><span class="pre">a</span></code> over. Well, Nuitka doesn’t do this. This is
despite the problem being known for quite some time.</p>
<p>With SSA in place, and “C-ish” code generation complete, this will be
solved, but I am not going to solve this before.</p>
</section>
</section>
<section id="standalone">
<h2><a class="toc-backref" href="#id12">Standalone</a><a class="headerlink" href="#standalone" title="Permalink to this headline"></a></h2>
<p>The standalone mode of Nuitka is pretty good, and in the pre-release it
was again improved. For instance, virtualenv and standalone should work
now, and more modules are supported.</p>
<p>However, there are known issues with <code class="docutils literal notranslate"><span class="pre">win32com</span></code> and a few other
packages, which need to be debugged. Mostly these are modules doing
nasty things that make Nuitka not automatically detect imports.</p>
<p>This has as usual only so much priority from me. I am working on this on
some occasions, as kind of interesting puzzles to solve. Most of the
time, it just works though, with <code class="docutils literal notranslate"><span class="pre">wxpython</span></code> being the most notable
exception. I am going to work on that though.</p>
<p>The standalone compilation exhibits scalability problems of Nuitka the
most, and while it has been getting better, the recent and future
improvements will lead to smaller code, which in turn means not only
smaller executables, but also faster compilation. Again, <code class="docutils literal notranslate"><span class="pre">wxpython</span></code> is
a major offender there, due to its many constants, global variables,
etc. in the bindings, while Qt, PySide, and GTK are apparently already
good.</p>
</section>
<section id="other-stuff">
<h2><a class="toc-backref" href="#id13">Other Stuff</a><a class="headerlink" href="#other-stuff" title="Permalink to this headline"></a></h2>
<section id="funding">
<h3><a class="toc-backref" href="#id14">Funding</a><a class="headerlink" href="#funding" title="Permalink to this headline"></a></h3>
<p>Nuitka doesn’t receive enough <a class="reference external" href="/pages/donations.html">donations</a>. There is no support from
organizations like e.g. the PSF, which recently backed several projects
by doubling donations given to them.</p>
<p>I remember talking to a PSF board member during Europython 2013 about
this, and the reaction was fully in line with the Europython 2012
feedback towards me from the dictator. They wouldn’t help Nuitka in any
way before it is successful.</p>
<p>I have never officially applied for help with funding though with them.
I am going to choose to take pride in that, I suppose.</p>
</section>
<section id="collaborators">
<h3><a class="toc-backref" href="#id15">Collaborators</a><a class="headerlink" href="#collaborators" title="Permalink to this headline"></a></h3>
<p>My quest to find collaborators to Nuitka is largely failing. Aside from
the standalone mode, there have been too little contributions. Hope is
that it will change in the future, once the significant speed gains
arrive. And it might be my fault for not asking for help more, and to
arrange myself with that state of things.</p>
<p>Not being endorsed by the Python establishment is clearly limiting the
visibility of the project.</p>
<p>Anyway, things are coming along nicely. When I started out, I was fully
aware that the project is something that I can do on my own if
necessary, and that has not changed. Things are going slower than
necessary though, but that’s probably very typical.</p>
<p>But you can join now, just <a class="reference external" href="/doc/user-manual.html#join-nuitka">follow this link</a> or become part of
the mailing list (since closed) and help me there with request I make,
e.g. review posts of mine, test out things, pick up small jobs, answer
questions of newcomers, you know the drill probably.</p>
</section>
</section>
<section id="future">
<h2><a class="toc-backref" href="#id16">Future</a><a class="headerlink" href="#future" title="Permalink to this headline"></a></h2>
<p>So, there is multiple things going on:</p>
<ul>
<li><p>More “C-ish” code generation</p>
<p>The next release is going to be more “C-ish” than before, generating
less complex code than before, and removes the previous
optimizations, which were a lot of code, to e.g. detect parameter
variables without <code class="docutils literal notranslate"><span class="pre">del</span></code> statements.</p>
<p>This prong of action will have to continue, as it unblocks further
changes that lead to more compatibility and correctness.</p>
</li>
<li><p>More SSA usage</p>
<p>The next release did and will find bugs in the SSA tracing of Nuitka.
It is on purpose only using it, to add <code class="docutils literal notranslate"><span class="pre">assert</span></code> statements to
things it now no longer does. These will trigger in tests or cause
crashes, which then can be fixed.</p>
<p>We better know that SSA is flawless in its tracking, before we use it
to make optimizations, which then have no chance to assert anything
at all anymore.</p>
<p>Once we take it to that next level, Nuitka will be able to speed up
some things by more than the factor it basically has provided for 2
years now, and it’s probably going to happen this year.</p>
</li>
<li><p>More compatibility</p>
<p>The new <code class="docutils literal notranslate"><span class="pre">exec</span></code> code makes the dictionary synchronization explicit,
and e.g. now it is optimized away to even check for its need, if we
are in a module or a class, or if it can be known.</p>
<p>That means faster <code class="docutils literal notranslate"><span class="pre">exec</span></code>, but more importantly, a better understood
<code class="docutils literal notranslate"><span class="pre">exec</span></code>, with improved ability to do <code class="docutils literal notranslate"><span class="pre">SSA</span></code> traces for them. Being
able to in-line them, or to know the limit of their impact, as it
will help to know more invariants for that code.</p>
</li>
</ul>
<p>When these 3 things come to term, Nuitka will be a huge, huge step ahead
towards being truly a static optimizing compiler (so far it is mostly
only peep hole optimization, and byte code avoidance). I still think of
this as happening this year.</p>
</section>
</section>

<div class="section">
    

<div class="section">
  <span style="float: left">
     Previous:
    
    <a href="nuitka-release-054.html">
       Nuitka Release 0.5.4
    </a>
    
  </span>
  <span>&nbsp;</span>
  <span style="float: right">
     Next: 
    <a href="nuitka-release-055.html">
      Nuitka Release 0.5.5 
    </a>
    
  </span>
</div>
  
</div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Kay Hayen and Nuitka Contributors.</p>
  </div>

  
<div class='share-button-container'>
    <div class="socialbutton-wrapper">
        <a href="https://twitter.com/share?url=https://nuitka.net/posts/nuitka-shaping-up.html&hashtags=nuitka" target="_blank">
            <div class="socialbutton twitter" data-share-url="https://nuitka.net">
                <p class="icon">
                    <img src="/_static/icon-twitter.png">
                </p>

                <p class="shares">share...</p>
            </div>
        </a>

        <a href="https://www.facebook.com/sharer.php?u=https://nuitka.net/posts/nuitka-shaping-up.html&hashtag=%23nuitka"  target="_blank">
            <div class="socialbutton facebook" data-share-url="https://nuitka.net">
                <p class="icon">
                    <img src="/_static/icon-facebook.png">
                </p>

                <p class="shares">share...</p>
            </div>
        </a>

        <a href="http://www.reddit.com/submit?url=https://nuitka.net/posts/nuitka-shaping-up.html" target="_blank">
            <div class="socialbutton reddit">
                <p class="icon">
                    <img src="/_static/icon-reddit.png">
                </p>

                <p class="shares">share...</p>
            </div>
        </a>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
      $('a[href^="http://"], a[href^="https://"]').not('a[class*=internal]').attr('target', '_blank');
    });
  </script>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V73VK1T804"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-V73VK1T804', {
          'anonymize_ip': true,
      });
    </script> 

</body>
</html>