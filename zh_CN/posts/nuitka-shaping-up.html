
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />    <link rel="icon" href="../_static/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="../_static/favicon.png" sizes="32x32" type="image/png">
    <link rel="icon" href="../_static/favicon.ico" sizes="32x32" type="image/x-icon">
    <link rel="icon" href="../_static/apple-touch-icon-iphone.png" sizes="57x57" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-ipad.png" sizes="72x72" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-iphone4.png" sizes="114x114" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-ipad3.png" sizes="144x144" type="image/png">
    <link rel="apple-touch-icon" href="../_static/apple-touch-icon-180x180.png" sizes="180x180" type="image/png">

    <title>Nuitka shaping up</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/asciinema-player_2.6.1.css" />
    <link rel="stylesheet" type="text/css" href="../_static/asciinema-custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my_theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.59c74d8c95b765a7fd995ac71d459ebe.min.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/tabs.js"></script>
    <script src="../_static/asciinema-player_2.6.1.js"></script>
    <script src="../_static/translations.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <link rel="canonical" href="https://nuitka.net/posts/nuitka-shaping-up.html" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" /> 
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="zh_CN">
    

    <!-- Google Analytics -->
     
<link
  rel="alternate"
  type="application/atom+xml"
  href="../posts/atom.xml"
  title="Nuitka Blog"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
          
<h2>
   
  02 October 2014 
</h2>

<ul>
   
<li id="author">
  <span
    >作者:</span
  >
   
  <a href="author/kay-hayen.html">Kay Hayen</a>  
</li>
    
<li id="tags">
  <span
    >标签: </span
  >
   
  <a href="tag/python.html">Python</a>   
  <a href="tag/compiler.html">compiler</a>   
  <a href="tag/nuitka.html">Nuitka</a>  
</li>
 
</ul>

<h3>
  <a href="../posts.html">最近帖子</a>
</h3>
<ul>
   
  <li>
    <a href="nuitka-release-0618.html"
      >11 December - Nuitka Release 0.6.18</a
    >
  </li>
  
  <li>
    <a href="nuitka-release-0617.html"
      >11 November - Nuitka Release 0.6.17</a
    >
  </li>
  
  <li>
    <a href="nuitka-release-0616.html"
      >09 September - Nuitka Release 0.6.16</a
    >
  </li>
  
  <li>
    <a href="nuitka-release-0615.html"
      >05 June - Nuitka Release 0.6.15</a
    >
  </li>
  
  <li>
    <a href="nuitka-release-0614.html"
      >01 May - Nuitka Release 0.6.14</a
    >
  </li>
  
</ul>

<h3><a href="tag.html">标签</a></h3>
<style type="text/css">
  ul.ablog-cloud {
    list-style: none;
    overflow: auto;
  }
  ul.ablog-cloud li {
    float: left;
    height: 20pt;
    line-height: 18pt;
    margin-right: 5px;
  }
  ul.ablog-cloud a {
    text-decoration: none;
    vertical-align: middle;
  }
  li.ablog-cloud-1 {
    font-size: 80%;
  }
  li.ablog-cloud-2 {
    font-size: 95%;
  }
  li.ablog-cloud-3 {
    font-size: 110%;
  }
  li.ablog-cloud-4 {
    font-size: 125%;
  }
  li.ablog-cloud-5 {
    font-size: 140%;
  }
</style>
<ul class="ablog-cloud">
   
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/android.html">Android</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/debian.html">Debian</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/ntw.html">NTW</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/nikola.html">Nikola</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-5">
    <a href="tag/nuitka.html">Nuitka</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-5">
    <a href="tag/python.html">Python</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/windows.html">Windows</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/automation.html">automation</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/benchmark.html">benchmark</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-4">
    <a href="tag/compiler.html">compiler</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/conference.html">conference</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/europython.html">europython</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/family.html">family</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/git.html">git</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/gsoc2019.html">gsoc2019</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/physics.html">physics</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/portrait.html">portrait</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/presentation.html">presentation</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/pypi.html">pypi</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/pytest.html">pytest</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/quiz.html">quiz</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/standalone.html">standalone</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/tests.html">tests</a>
  </li>
    
  <li class="ablog-cloud ablog-cloud-1">
    <a href="tag/video.html">video</a>
  </li>
   
</ul>

<h3>
  <a href="archive.html">归档</a>
</h3>
<ul>
   
  <li>
    <a href="2021.html">2021 (8)</a>
  </li>
    
  <li>
    <a href="2020.html">2020 (5)</a>
  </li>
    
  <li>
    <a href="2019.html">2019 (14)</a>
  </li>
    
  <li>
    <a href="2018.html">2018 (17)</a>
  </li>
    
  <li>
    <a href="2017.html">2017 (4)</a>
  </li>
    
  <li>
    <a href="2016.html">2016 (8)</a>
  </li>
    
  <li>
    <a href="2015.html">2015 (16)</a>
  </li>
    
  <li>
    <a href="2014.html">2014 (12)</a>
  </li>
    
  <li>
    <a href="2013.html">2013 (24)</a>
  </li>
    
  <li>
    <a href="2012.html">2012 (21)</a>
  </li>
    
  <li>
    <a href="2011.html">2011 (25)</a>
  </li>
    
  <li>
    <a href="2010.html">2010 (19)</a>
  </li>
   
</ul>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="切换导航" aria-controls="site-navigation"
                title="切换导航" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="下载此页面"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/"><button type="button"
                class="btn btn-secondary topbarbtn" title="下载源文件" data-toggle="tooltip"
                data-placement="left">.rst</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="列印成PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="全屏模式"
        title="全屏模式"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> 内容
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ssa-single-state-assignment-form">
   SSA (Single State Assignment Form)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#improved-code-generation">
   Improved Code Generation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scalability">
   Scalability
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compatibility">
   Compatibility
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#python2-exec-statements">
     Python2 exec statements
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#python3-classes">
     Python3 classes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#python3-4">
     Python3.4
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performance">
   Performance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#graphs-and-benchmarks">
     Graphs and Benchmarks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#incremental-assignments">
     Incremental Assignments
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#standalone">
   Standalone
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-stuff">
   Other Stuff
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#funding">
     Funding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#collaborators">
     Collaborators
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#future">
   Future
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Nuitka shaping up</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> 内容 </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ssa-single-state-assignment-form">
   SSA (Single State Assignment Form)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#improved-code-generation">
   Improved Code Generation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scalability">
   Scalability
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compatibility">
   Compatibility
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#python2-exec-statements">
     Python2 exec statements
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#python3-classes">
     Python3 classes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#python3-4">
     Python3.4
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performance">
   Performance
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#graphs-and-benchmarks">
     Graphs and Benchmarks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#incremental-assignments">
     Incremental Assignments
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#standalone">
   Standalone
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-stuff">
   Other Stuff
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#funding">
     Funding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#collaborators">
     Collaborators
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#future">
   Future
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                 <div class="section" id="nuitka-shaping-up">
<h1><a class="toc-backref" href="#id2">Nuitka shaping up</a><a class="headerlink" href="#nuitka-shaping-up" title="永久链接至标题">¶</a></h1>
<p>Not much has happened publicly to Nuitka, so it’s time to make a kind of
status post, about the exciting news there is.</p>
<div class="contents topic" id="id1">
<p class="topic-title">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#nuitka-shaping-up" id="id2">Nuitka shaping up</a></p>
<ul>
<li><p><a class="reference internal" href="#ssa-single-state-assignment-form" id="id3">SSA (Single State Assignment Form)</a></p></li>
<li><p><a class="reference internal" href="#improved-code-generation" id="id4">Improved Code Generation</a></p></li>
<li><p><a class="reference internal" href="#scalability" id="id5">Scalability</a></p></li>
<li><p><a class="reference internal" href="#compatibility" id="id6">Compatibility</a></p>
<ul>
<li><p><a class="reference internal" href="#python2-exec-statements" id="id7">Python2 exec statements</a></p></li>
<li><p><a class="reference internal" href="#python3-classes" id="id8">Python3 classes</a></p></li>
<li><p><a class="reference internal" href="#python3-4" id="id9">Python3.4</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#performance" id="id10">Performance</a></p>
<ul>
<li><p><a class="reference internal" href="#graphs-and-benchmarks" id="id11">Graphs and Benchmarks</a></p></li>
<li><p><a class="reference internal" href="#incremental-assignments" id="id12">Incremental Assignments</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#standalone" id="id13">Standalone</a></p></li>
<li><p><a class="reference internal" href="#other-stuff" id="id14">Other Stuff</a></p>
<ul>
<li><p><a class="reference internal" href="#funding" id="id15">Funding</a></p></li>
<li><p><a class="reference internal" href="#collaborators" id="id16">Collaborators</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#future" id="id17">Future</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="ssa-single-state-assignment-form">
<h2><a class="toc-backref" href="#id3">SSA (Single State Assignment Form)</a><a class="headerlink" href="#ssa-single-state-assignment-form" title="永久链接至标题">¶</a></h2>
<p>For a long, long time already, each release of Nuitka has worked towards
enabling <a class="reference external" href="http://en.wikipedia.org/wiki/Static_single_assignment_form">“SSA”</a> usage in
Nuitka. There is a component called “constraint collection”, which is
tasked with driving the optimization, and collecting variable traces.</p>
<p>Based on these traces, optimizations could be made. Having SSA or not,
is (to me) the difference between Nuitka as a compiler, and Nuitka as an
optimizing compiler.</p>
<p>The news is, SSA is shaping up, and will be used in the next release.
Not yet to drive variable based optimization (reserved for a release
after it), but to aid the code generation to avoid useless checks.</p>
</div>
<div class="section" id="improved-code-generation">
<h2><a class="toc-backref" href="#id4">Improved Code Generation</a><a class="headerlink" href="#improved-code-generation" title="永久链接至标题">¶</a></h2>
<p>Previously, under the title “C-ish”, Nuitka moved away from C++ based
code generation to less C++ based code generated, and more C-ish code.
This trend continues, and has lead to removing even more code cleanups.</p>
<p>The more important change is from the SSA derived knowledge. Now Nuitka
knows that a variable must be assigned, cannot be assigned, may be
assigned, based on its SSA traces.</p>
<p>Lets check out an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>
</pre></div>
</div>
<p>Nevermind, that <em>obviously</em> the variable <code class="docutils literal notranslate"><span class="pre">a</span></code> can be removed, and this
could be transformed to statically return <code class="docutils literal notranslate"><span class="pre">1</span></code>. That is the next step
(and easy if SSA is working properly), now we are looking at what
changed now.</p>
<p>This is code as generated now, with current 0.5.5pre5:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_assign_source_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const_int_pos_1</span><span class="p">;</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INCREASE_REFCOUNT</span><span class="p">(</span><span class="w"> </span><span class="n">tmp_assign_source_1</span><span class="w"> </span><span class="p">);</span><span class="w"></span>

<span class="n">tmp_return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="p">;</span><span class="w"></span>

<span class="n">Py_INCREF</span><span class="p">(</span><span class="w"> </span><span class="n">tmp_return_value</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="k">goto</span><span class="w"> </span><span class="n">function_return_exit</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>There are some things, wrong with it still. For one, <code class="docutils literal notranslate"><span class="pre">var_a</span></code> is still
a C++ object, which we directly access. But the good thing is, we can
assert that it starts out uninitialized, before we overwrite it. The
stable release as of now, 0.5.4, generates code like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_assign_source_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const_int_pos_1</span><span class="p">;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INCREASE_REFCOUNT</span><span class="p">(</span><span class="w"> </span><span class="n">tmp_assign_source_1</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">else</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INCREASE_REFCOUNT</span><span class="p">(</span><span class="w"> </span><span class="n">tmp_assign_source_1</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">PyFrameObject</span><span class="w"> </span><span class="o">*</span><span class="n">cache_frame_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="n">MAKE_OR_REUSE_FRAME</span><span class="p">(</span><span class="w"> </span><span class="n">cache_frame_function</span><span class="p">,</span><span class="w"> </span><span class="n">codeobj_4e03e5698a52dd694c5c263550d71551</span><span class="p">,</span><span class="w"> </span><span class="n">module___main__</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="n">PyFrameObject</span><span class="w"> </span><span class="o">*</span><span class="n">frame_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache_frame_function</span><span class="p">;</span><span class="w"></span>

<span class="c1">// Push the new frame as the currently active one.</span>
<span class="n">pushFrameStack</span><span class="p">(</span><span class="w"> </span><span class="n">frame_function</span><span class="w"> </span><span class="p">);</span><span class="w"></span>

<span class="c1">// Mark the frame object as in use, ref count 1 will be up for reuse.</span>
<span class="n">Py_INCREF</span><span class="p">(</span><span class="w"> </span><span class="n">frame_function</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="n">Py_REFCNT</span><span class="p">(</span><span class="w"> </span><span class="n">frame_function</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// Frame stack</span>

<span class="c1">// Framed code:</span>
<span class="n">tmp_return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var_a</span><span class="p">.</span><span class="n">object</span><span class="p">;</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tmp_return_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">exception_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INCREASE_REFCOUNT</span><span class="p">(</span><span class="w"> </span><span class="n">PyExc_UnboundLocalError</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">exception_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSTREAM_STRING</span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="n">constant_bin</span><span class="p">[</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">exception_tb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">frame_function</span><span class="o">-&gt;</span><span class="n">f_lineno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">frame_exception_exit_1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">Py_INCREF</span><span class="p">(</span><span class="w"> </span><span class="n">tmp_return_value</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="k">goto</span><span class="w"> </span><span class="n">frame_return_exit_1</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>As you can see, the assignment to <code class="docutils literal notranslate"><span class="pre">var_a.object</span></code> was checking if it
were <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, and if were not (which we now statically know), would
release the old value. Next up, before returning, the value of
<code class="docutils literal notranslate"><span class="pre">var_a.object</span></code> needed to be checked, if it were <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, in which
case, we would need to create a Python exception, and in order to do so,
we need to create a frame object, that even if cached, consumes time,
and code size.</p>
<p>So, that is the major change to code generation. The SSA information is
now used in it, and doing so, has found a bunch of issues, in how it is
built, in e.g. nested branches, that kind of stuff.</p>
<p>The removal of local variables as C++ classes, and them managed as
temporary variables, is going to happen in a future release, reducing
code complexity further. Were <code class="docutils literal notranslate"><span class="pre">a</span></code> a temporary variable, already, the
<code class="docutils literal notranslate"><span class="pre">Py_INCREF</span></code> which implies a later <code class="docutils literal notranslate"><span class="pre">Py_DECREF</span></code> on the constant <code class="docutils literal notranslate"><span class="pre">1</span></code>
could be totally avoided.</p>
</div>
<div class="section" id="scalability">
<h2><a class="toc-backref" href="#id5">Scalability</a><a class="headerlink" href="#scalability" title="永久链接至标题">¶</a></h2>
<p>The scalability of Nuitka hinges much of generated code size. With it
being less stupid, the generated code is now not only faster, but
definitely smaller, and with more optimization, it will only become more
practical.</p>
</div>
<div class="section" id="compatibility">
<h2><a class="toc-backref" href="#id6">Compatibility</a><a class="headerlink" href="#compatibility" title="永久链接至标题">¶</a></h2>
<div class="section" id="python2-exec-statements">
<h3><a class="toc-backref" href="#id7">Python2 exec statements</a><a class="headerlink" href="#python2-exec-statements" title="永久链接至标题">¶</a></h3>
<p>A recent change in CPython 2.7.8+ which is supposed to become 2.7.9 one
day, highlighted an issue with <code class="docutils literal notranslate"><span class="pre">exec</span></code> statements in Nuitka. These were
considered to be fully compatible, but apparently are not totally.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">exec</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
    <span class="n">exec</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>The above two are supposed to be identical. So far this was rectified at
run time of CPython, but apparently the parser is now tasked with it, so
Nuitka now sees <code class="docutils literal notranslate"><span class="pre">exec</span> <span class="pre">a</span> <span class="pre">in</span> <span class="pre">b,</span> <span class="pre">c</span></code> for both lines. Which is good.</p>
<p>However, as it stands, Nuitka handles <code class="docutils literal notranslate"><span class="pre">exec</span></code> in <code class="docutils literal notranslate"><span class="pre">locals()</span></code> the same
as <code class="docutils literal notranslate"><span class="pre">exec</span></code> in <code class="docutils literal notranslate"><span class="pre">None</span></code> for plain functions (OK to classes and modules),
which is totally a bug.</p>
<p>I have been working on an enhanced re-formulation (it needs to be
tracked if the value was <code class="docutils literal notranslate"><span class="pre">None</span></code>, and then the sync back to locals from
the provided dictionary ought to be done. But the change breaks
<code class="docutils literal notranslate"><span class="pre">execfile</span></code> in classes, which was implemented piggy-backing on
<code class="docutils literal notranslate"><span class="pre">exec</span></code>, and now requires locals to be a dictionary, and immediately
written to.</p>
<p>Anyway, consider <code class="docutils literal notranslate"><span class="pre">exec</span></code> as well working already. The non-working cases
are really corner cases, obviously nobody came across so far.</p>
</div>
<div class="section" id="python3-classes">
<h3><a class="toc-backref" href="#id8">Python3 classes</a><a class="headerlink" href="#python3-classes" title="永久链接至标题">¶</a></h3>
<p>Incidentally, that <code class="docutils literal notranslate"><span class="pre">execfile</span></code> issue will be solved as soon as a bug is
fixed, that was exposed by new abilities of Python3 metaclasses. They
were first observed in Python3.4 enum classes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyEnum</span><span class="p">(</span><span class="n">enum</span><span class="p">):</span>
    <span class="n">red</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">blue</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">red</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># error</span>
</pre></div>
</div>
<p>Currently, Nuitka is delaying the building of the dictionary (absent
<code class="docutils literal notranslate"><span class="pre">execfile</span></code> built-in), and that is not allowed, in fact, immediate
writes to the mapping giving by <code class="docutils literal notranslate"><span class="pre">__prepare__</span></code> of the metaclass will be
required, in which case, the <code class="docutils literal notranslate"><span class="pre">enum</span></code> class can raise an error for the
second assignment to <code class="docutils literal notranslate"><span class="pre">red</span></code>.</p>
<p>So that area now hinges on code generation to learn different local
variable codes for classes, centered around the notion of using the
locals dictionary immediately.</p>
</div>
<div class="section" id="python3-4">
<h3><a class="toc-backref" href="#id9">Python3.4</a><a class="headerlink" href="#python3-4" title="永久链接至标题">¶</a></h3>
<p>The next release is no longer warning you if you use Python3.4, as many
of the remaining problems have been sorted out. Many small things were
found, and in some cases these highlighted general Python3 problems.</p>
<p>Nuitka for Python3 is not yet all that much in the focus in terms of
performance, but correctness will have become much better, with most
prominently, exception context being now correct most often.</p>
<p>The main focus of Nuitka is Python2, but to Nuitka the incompatibility
of Python3 is largely not all that much an issue. The re-formulations to
lower level operations for just about everything means that for the
largest part there is not much trouble in supporting a mostly only
slightly different version of Python.</p>
<p>The gain is mostly in that new tests are added in new releases, and
these sometimes find things that affect Nuitka in all versions, or at
least some others. And this could be a mere reference leak.</p>
<p>Consider this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">raise</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>So, that is working with Python2, but comes from a Python3 test. Python2
is supposed to unwrap the tuple and take the first argument and raise
that. It didn’t do that so far. Granted, obscure feature, but still an
incompatibility. For Python3, a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> should be raised
complaining that <code class="docutils literal notranslate"><span class="pre">tuple</span></code> is not derived from <code class="docutils literal notranslate"><span class="pre">BaseException</span></code>.</p>
<p>Turned out, that also, in that case, a reference leak occurs, in that
the wrong exception was not released, and therefore memory leaked.
Should that happen a lot during a programs live, it will potentially
become an issue, as it keeps frames on the traceback also alive.</p>
<p>So this lead to a compatibility fix and a reference leak fix. And it was
found by the Python3.4 suite, checking that exception objects are
properly released, and that the proper kind of exception is raised in
the no longer supported case.</p>
</div>
</div>
<div class="section" id="performance">
<h2><a class="toc-backref" href="#id10">Performance</a><a class="headerlink" href="#performance" title="永久链接至标题">¶</a></h2>
<div class="section" id="graphs-and-benchmarks">
<h3><a class="toc-backref" href="#id11">Graphs and Benchmarks</a><a class="headerlink" href="#graphs-and-benchmarks" title="永久链接至标题">¶</a></h3>
<p>I had been working on automated performance graphs, and they are
supposed to show up on <a class="reference external" href="https://speedcenter.nuitka.net">Nuitka Speedcenter</a> already, but currently it’s broken
and outdated.</p>
<p>Sad state of affairs. Reasons include that I found it too ugly to
publish unless updated to latest Nikola, for which I didn’t take the
time. I intend to fix it, potentially before the release though.</p>
</div>
<div class="section" id="incremental-assignments">
<h3><a class="toc-backref" href="#id12">Incremental Assignments</a><a class="headerlink" href="#incremental-assignments" title="永久链接至标题">¶</a></h3>
<p>Consider the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">+=</span> <span class="s2">&quot;bbb&quot;</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">a</span></code> is a <code class="docutils literal notranslate"><span class="pre">str</span></code>, and if (and only if), it’s the only reference
being held, then CPython, reuses the object, instead of creating a new
object and copying <code class="docutils literal notranslate"><span class="pre">a</span></code> over. Well, Nuitka doesn’t do this. This is
despite the problem being known for quite some time.</p>
<p>With SSA in place, and “C-ish” code generation complete, this will be
solved, but I am not going to solve this before.</p>
</div>
</div>
<div class="section" id="standalone">
<h2><a class="toc-backref" href="#id13">Standalone</a><a class="headerlink" href="#standalone" title="永久链接至标题">¶</a></h2>
<p>The standalone mode of Nuitka is pretty good, and in the pre-release it
was again improved. For instance, virtualenv and standalone should work
now, and more modules are supported.</p>
<p>However, there are known issues with <code class="docutils literal notranslate"><span class="pre">win32com</span></code> and a few other
packages, which need to be debugged. Mostly these are modules doing
nasty things that make Nuitka not automatically detect imports.</p>
<p>This has as usual only so much priority from me. I am working on this on
some occasions, as kind of interesting puzzles to solve. Most of the
time, it just works though, with <code class="docutils literal notranslate"><span class="pre">wxpython</span></code> being the most notable
exception. I am going to work on that though.</p>
<p>The standalone compilation exhibits scalability problems of Nuitka the
most, and while it has been getting better, the recent and future
improvements will lead to smaller code, which in turn means not only
smaller executables, but also faster compilation. Again, <code class="docutils literal notranslate"><span class="pre">wxpython</span></code> is
a major offender there, due to its many constants, global variables,
etc. in the bindings, while Qt, PySide, and GTK are apparently already
good.</p>
</div>
<div class="section" id="other-stuff">
<h2><a class="toc-backref" href="#id14">Other Stuff</a><a class="headerlink" href="#other-stuff" title="永久链接至标题">¶</a></h2>
<div class="section" id="funding">
<h3><a class="toc-backref" href="#id15">Funding</a><a class="headerlink" href="#funding" title="永久链接至标题">¶</a></h3>
<p>Nuitka doesn’t receive enough <a class="reference external" href="/pages/donations.html">donations</a>. There is no support from
organizations like e.g. the PSF, which recently backed several projects
by doubling donations given to them.</p>
<p>I remember talking to a PSF board member during Europython 2013 about
this, and the reaction was fully in line with the Europython 2012
feedback towards me from the dictator. They wouldn’t help Nuitka in any
way before it is successful.</p>
<p>I have never officially applied for help with funding though with them.
I am going to choose to take pride in that, I suppose.</p>
</div>
<div class="section" id="collaborators">
<h3><a class="toc-backref" href="#id16">Collaborators</a><a class="headerlink" href="#collaborators" title="永久链接至标题">¶</a></h3>
<p>My quest to find collaborators to Nuitka is largely failing. Aside from
the standalone mode, there have been too little contributions. Hope is
that it will change in the future, once the significant speed gains
arrive. And it might be my fault for not asking for help more, and to
arrange myself with that state of things.</p>
<p>Not being endorsed by the Python establishment is clearly limiting the
visibility of the project.</p>
<p>Anyway, things are coming along nicely. When I started out, I was fully
aware that the project is something that I can do on my own if
necessary, and that has not changed. Things are going slower than
necessary though, but that’s probably very typical.</p>
<p>But you can join now, just <a class="reference external" href="/doc/user-manual.html#join-nuitka">follow this link</a> or become part of
the mailing list (since closed) and help me there with request I make,
e.g. review posts of mine, test out things, pick up small jobs, answer
questions of newcomers, you know the drill probably.</p>
</div>
</div>
<div class="section" id="future">
<h2><a class="toc-backref" href="#id17">Future</a><a class="headerlink" href="#future" title="永久链接至标题">¶</a></h2>
<p>So, there is multiple things going on:</p>
<ul>
<li><p>More “C-ish” code generation</p>
<p>The next release is going to be more “C-ish” than before, generating
less complex code than before, and removes the previous
optimizations, which were a lot of code, to e.g. detect parameter
variables without <code class="docutils literal notranslate"><span class="pre">del</span></code> statements.</p>
<p>This prong of action will have to continue, as it unblocks further
changes that lead to more compatibility and correctness.</p>
</li>
<li><p>More SSA usage</p>
<p>The next release did and will find bugs in the SSA tracing of Nuitka.
It is on purpose only using it, to add <code class="docutils literal notranslate"><span class="pre">assert</span></code> statements to
things it now no longer does. These will trigger in tests or cause
crashes, which then can be fixed.</p>
<p>We better know that SSA is flawless in its tracking, before we use it
to make optimizations, which then have no chance to assert anything
at all anymore.</p>
<p>Once we take it to that next level, Nuitka will be able to speed up
some things by more than the factor it basically has provided for 2
years now, and it’s probably going to happen this year.</p>
</li>
<li><p>More compatibility</p>
<p>The new <code class="docutils literal notranslate"><span class="pre">exec</span></code> code makes the dictionary synchronization explicit,
and e.g. now it is optimized away to even check for its need, if we
are in a module or a class, or if it can be known.</p>
<p>That means faster <code class="docutils literal notranslate"><span class="pre">exec</span></code>, but more importantly, a better understood
<code class="docutils literal notranslate"><span class="pre">exec</span></code>, with improved ability to do <code class="docutils literal notranslate"><span class="pre">SSA</span></code> traces for them. Being
able to in-line them, or to know the limit of their impact, as it
will help to know more invariants for that code.</p>
</li>
</ul>
<p>When these 3 things come to term, Nuitka will be a huge, huge step ahead
towards being truly a static optimizing compiler (so far it is mostly
only peep hole optimization, and byte code avoidance). I still think of
this as happening this year.</p>
</div>
</div>

<div class="section">
    

<div class="section">
  <span style="float: left">
     上一页:
    
    <a href="nuitka-release-054.html">
       Nuitka Release 0.5.4
    </a>
    
  </span>
  <span>&nbsp;</span>
  <span style="float: right">
     下一页: 
    <a href="nuitka-release-055.html">
      Nuitka Release 0.5.5 
    </a>
    
  </span>
</div>
  
</div>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      通过 Kay Hayen<br/>
    
        &copy; 版权 2022, Kay Hayen and Nuitka Contributors.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>